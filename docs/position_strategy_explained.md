# 建仓策略详解

## 🎯 建仓策略是什么？

**建仓策略（Position Strategy）** 是一个智能的**仓位管理系统**，用来决定：
- 如何分配资金
- 什么时候买入
- 买多少
- 如何降低风险

简单来说：**不是一次性把钱全投进去，而是分批、有计划地建仓**。

---

## 💡 为什么需要建仓策略？

### 问题场景

假设你有 50 USDT，AI 给出买入信号：

**❌ 没有建仓策略（之前的做法）**：
```
一次性买入 50 USDT @ 0.10
  ↓
如果价格继续下跌到 0.095
  ↓
你：😭 买贵了，没钱加仓了
平均成本：0.10
```

**✅ 有建仓策略（金字塔）**：
```
第1批: 25 USDT @ 0.10  (立即买入)
  ↓ 价格下跌
第2批: 15 USDT @ 0.098 (下跌2%时买入)
  ↓ 价格继续下跌
第3批: 10 USDT @ 0.096 (下跌4%时买入)

平均成本：(25×0.10 + 15×0.098 + 10×0.096) / 50 = 0.0986
节省：1.4% ✅
```

---

## 📊 三种建仓策略

### 1. 全仓策略 (Full)

**适用**：AI 置信度 ≥ 0.75（非常确定）

**特点**：
- 一次性投入 100%
- 快速建仓
- 风险较高

**示例**：
```
信号：买入 DOGE，置信度 0.82
策略：全仓
  ↓
立即买入 50 USDT @ 0.10
```

**止盈止损**：
- 止盈：5%
- 止损：2%

---

### 2. 金字塔策略 (Pyramid) ⭐ 推荐

**适用**：AI 置信度 0.60-0.75（比较确定）

**特点**：
- 分3批建仓
- 首批 50%，后续逐步减少
- 价格下跌时加仓
- **降低平均成本**

**示例**：
```
信号：买入 DOGE，置信度 0.72
策略：金字塔
  ↓
第1批: 25 USDT @ 0.10  (50%, 立即执行)
第2批: 15 USDT @ 0.098 (30%, 下跌2%时)
第3批: 10 USDT @ 0.096 (20%, 下跌4%时)
```

**止盈止损**：
- 止盈：8%
- 止损：3%

**优势**：
- ✅ 逢低加仓，降低成本
- ✅ 分散风险
- ✅ 适应市场波动
- ✅ 心理压力小

---

### 3. 网格策略 (Grid)

**适用**：AI 置信度 < 0.60（不太确定）

**特点**：
- 分5批建仓
- 每批 20%
- 均匀分布
- 适合震荡行情

**示例**：
```
信号：买入 DOGE，置信度 0.58
策略：网格
  ↓
第1批: 10 USDT @ 0.10  (20%, 立即)
第2批: 10 USDT @ 0.099 (20%, -1%)
第3批: 10 USDT @ 0.098 (20%, -2%)
第4批: 10 USDT @ 0.097 (20%, -3%)
第5批: 10 USDT @ 0.096 (20%, -4%)
```

**止盈止损**：
- 止盈：10%
- 止损：4%

---

## 🎯 实际案例对比

### 案例：DOGE 交易

**市场情况**：
- 当前价格：0.10
- AI 信号：买入，置信度 0.72
- 风控批准：50 USDT

**价格走势**：
```
0.10 → 0.098 → 0.096 → 0.105 (反弹)
```

---

### 方案A：全仓（无策略）

```
买入：50 USDT @ 0.10 = 500 DOGE
  ↓
价格跌到 0.096 (亏损 4%)
  ↓
价格反弹到 0.105
  ↓
盈利：(0.105 - 0.10) / 0.10 = 5%
收益：2.5 USDT
```

---

### 方案B：金字塔策略

```
第1批: 25 USDT @ 0.10  = 250 DOGE
第2批: 15 USDT @ 0.098 = 153 DOGE (价格跌到0.098时触发)
第3批: 10 USDT @ 0.096 = 104 DOGE (价格跌到0.096时触发)
  ↓
总计：507 DOGE，平均成本 0.0986
  ↓
价格反弹到 0.105
  ↓
盈利：(0.105 - 0.0986) / 0.0986 = 6.5%
收益：3.25 USDT

比全仓多赚：30% ✅
```

---

## 🔄 完整流程

```
1. AI 生成信号
   信号：买入 DOGE
   置信度：0.72
   ↓

2. 风控评估
   批准金额：50 USDT
   ↓

3. 建仓策略生成 ← 这一步！
   策略：金字塔
   分批：3批 (50% + 30% + 20%)
   止盈：8%
   止损：3%
   ↓

4. 执行第1批
   立即买入：25 USDT @ 0.10
   ↓

5. 后续批次自动触发
   价格跌到 0.098 → 执行第2批
   价格跌到 0.096 → 执行第3批
   ↓

6. 等待止盈/止损
   价格涨到 0.1067 → 止盈 8%
   或
   价格跌到 0.0956 → 止损 3%
```

---

## 💰 收益对比

### 假设 10 次交易

**无建仓策略**：
- 胜率：60%
- 平均盈利：5%
- 平均亏损：3%
- 总收益：(6×5% - 4×3%) × 50 = 9 USDT

**金字塔策略**：
- 胜率：60%（相同）
- 平均盈利：6.5%（提高）
- 平均亏损：2.5%（降低）
- 总收益：(6×6.5% - 4×2.5%) × 50 = 14.5 USDT

**提升：61% ✅**

---

## 🎓 关键优势

### 1. 降低平均成本
- 逢低加仓
- 摊薄成本
- 提高盈利空间

### 2. 分散风险
- 不是一次性全投
- 价格不利时还有资金
- 心理压力小

### 3. 适应市场
- 价格波动时更有利
- 震荡行情也能盈利
- 减少踏空风险

### 4. 智能决策
- 根据 AI 置信度自动选择
- 高置信度 → 激进（全仓）
- 低置信度 → 保守（网格）

---

## 🔧 如何使用

### 自动模式（推荐）

系统会根据 AI 信号的置信度**自动选择**最优策略：

```
置信度 ≥ 0.75 → 全仓策略
置信度 0.60-0.75 → 金字塔策略 ⭐
置信度 < 0.60 → 网格策略
```

你**不需要手动设置**，系统自动处理！

### 查看策略

```bash
# 查看周期详情
curl http://localhost:8080/api/v1/cycles/{cycle_id}

# 返回包含建仓策略
{
  "position_strategy": {
    "strategy": "pyramid",
    "entry_levels": 3,
    "batches": [...],
    "take_profit_percent": 8.0,
    "stop_loss_percent": 3.0,
    "reason": "中等置信度(0.72)，采用金字塔策略分批建仓，降低风险"
  }
}
```

---

## 📈 实际效果

### 日志示例

```
[周期:abc123] 📊 建仓策略: 正在生成 ...
[建仓策略] DOGE/USDT 策略=pyramid 总金额=50.00 分批=3 止盈=8.0% 止损=3.0%
[周期:abc123] ✔ 建仓策略: pyramid 分批=3 止盈=8.0% 止损=3.0%
[周期:abc123] 📦 执行第1批: 25.00 USDT (共3批)
[周期:abc123] ✔ 执行: 订单已提交 数量=250.00

# 几小时后，价格下跌到 0.098
[批次执行器] 🎯 触发批次 DOGE/USDT 第2批 触发价=0.098 当前价=0.098
[批次执行器] ✔ 批次 2 执行成功 数量=153.06

# 又过了一段时间，价格下跌到 0.096
[批次执行器] 🎯 触发批次 DOGE/USDT 第3批 触发价=0.096 当前价=0.096
[批次执行器] ✔ 批次 3 执行成功 数量=104.17

# 最终持仓
总数量: 507.23 DOGE
平均成本: 0.0986
当前价格: 0.105
盈利: 6.5% 💰
```

---

## 🆚 对比总结

| 特性 | 无策略 | 有建仓策略 |
|------|--------|-----------|
| **建仓方式** | 一次性全投 | 分批建仓 |
| **平均成本** | 高 | 低 ✅ |
| **风险** | 高 | 分散 ✅ |
| **收益** | 标准 | 提升 30-60% ✅ |
| **心理压力** | 大 | 小 ✅ |
| **适应性** | 差 | 强 ✅ |

---

## 💡 总结

### 建仓策略的核心价值

1. **不是一次性买入，而是分批建仓**
2. **根据 AI 置信度智能选择策略**
3. **逢低加仓，降低平均成本**
4. **分散风险，提高胜率**
5. **自动执行，无需人工干预**

### 一句话解释

**建仓策略 = 聪明的分批买入计划，让你在价格波动中占据优势，降低成本，提高收益！**

---

## 🎯 你需要做什么？

**什么都不用做！**

系统会：
1. ✅ 自动根据 AI 置信度选择策略
2. ✅ 自动执行第1批
3. ✅ 自动监控价格
4. ✅ 自动触发后续批次
5. ✅ 自动止盈止损

你只需要：
- 查看日志
- 监控持仓
- 享受收益 💰
